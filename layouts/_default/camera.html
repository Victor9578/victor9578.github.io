<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <!-- 引入主题头部 (PaperMod 的 CSS 变量都在这里面) -->
  {{ partial "head.html" . }}
  <style>
    /* ================== 样式部分（与之前保持一致） ================== */
    :root {
      --gallery-gap: 4px;
      --gallery-header-bg: rgba(255, 255, 255, 0.95);
      --gallery-border: rgba(0, 0, 0, 0.05);
    }

    body.dark {
      --gallery-header-bg: rgba(29, 30, 32, 0.95);
      --gallery-border: rgba(255, 255, 255, 0.1);
    }

    body {
      overflow-x: hidden;
      background-color: var(--theme) !important;
      color: var(--primary) !important;
      padding-bottom: 50px;
    }

    #gallery-root {
      margin: 0 auto;
      padding: 0;
      width: 100%;
      max-width: calc(var(--nav-width) + var(--gap) * 2);
    }

    .month-section {
      margin-bottom: 20px;
      animation: fadeIn 0.5s ease-in;
    }

    .month-header {
      font-size: 1.5rem;
      font-weight: 400;
      color: var(--primary);
      padding: 24px 8px 16px;
      position: sticky;
      top: 0;
      background-color: var(--gallery-header-bg);
      backdrop-filter: blur(10px);
      z-index: 90;
      border-bottom: 1px solid var(--gallery-border);
      transition: background-color 0.3s;
    }

    .photo-grid {
      display: flex;
      flex-wrap: wrap;
      margin: calc(var(--gallery-gap) * -1);
    }

    .photo-grid::after {
      content: '';
      flex-grow: 999999999;
    }

    .photo-item {
      margin: var(--gallery-gap);
      position: relative;
      background-color: var(--entry);
      overflow: hidden;
      cursor: zoom-in;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .photo-item:hover {
      transform: translateY(-2px);
      z-index: 2;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .photo-placeholder {
      height: 0;
      width: 100%;
    }

    .photo-item img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.4s ease-out;
    }

    .photo-item img.loaded {
      opacity: 1;
    }

    #load-sentinel {
      text-align: center;
      padding: 40px;
      color: var(--secondary);
      font-size: 14px;
    }

    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(128, 128, 128, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 8px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #image-viewer {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(5px);
      flex-direction: column;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #image-viewer.active {
      display: flex;
      opacity: 1;
    }

    .viewer-toolbar {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1001;
      display: flex;
      gap: 20px;
    }

    #full-image {
      max-width: 95%;
      max-height: 95%;
      object-fit: contain;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    #image-viewer:-webkit-full-screen #full-image,
    #image-viewer:fullscreen #full-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
      box-shadow: none;
    }

    #viewer-close,
    #viewer-fullscreen {
      cursor: pointer;
      user-select: none;
      transition: opacity 0.2s;
      display: inline-block;
      color: #fff;
    }

    #viewer-close svg,
    #viewer-fullscreen svg {
      width: 32px;
      height: 32px;
      fill: currentColor;
    }

    #viewer-close:hover,
    #viewer-fullscreen:hover {
      opacity: 0.7;
    }

    #viewer-loading {
      position: absolute;
      color: #fff;
      border-top-color: #fff;
    }

    @media (max-width: 600px) {
      .month-header {
        font-size: 1.4rem;
        padding: 15px 5px;
      }

      .photo-item {
        margin: 2px;
      }

      .photo-grid {
        margin: -2px;
      }

      .viewer-toolbar {
        top: 10px;
        right: 10px;
        gap: 15px;
      }
    }
  </style>
</head>

<body class="list" id="top">
  <!-- 导航栏 -->
  {{ partial "header.html" . }}
  <!-- 主内容区 -->
  <main style="width: 100%; max-width: 100%; padding: 0; min-height: 80vh;">
    <div id="gallery-root"></div>
    <div id="load-sentinel">
      <div class="spinner" id="loading-spinner"></div>
      <div id="loading-text">正在连接云端相册...</div>
    </div>
  </main>
  <!-- Lightbox -->
  <div id="image-viewer">
    <div class="viewer-toolbar">
      <span id="viewer-fullscreen" title="全屏模式">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="m15 3l2.3 2.3l-2.89 2.87l1.42 1.42L18.7 6.7L21 9V3zM3 9l2.3-2.3l2.87 2.89l1.42-1.42L6.7 5.3L9 3H3zm6 12l-2.3-2.3l2.89-2.87l-1.42-1.42L5.3 17.3L3 15v6zm12-6l-2.3 2.3l-2.87-2.89l-1.42 1.42l2.89 2.87L15 21h6z" />
        </svg>
      </span>
      <span id="viewer-close" title="关闭">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z" />
        </svg>
      </span>
    </div>
    <div id="viewer-loading" class="spinner"></div>
    <img id="full-image">
  </div>
  <!-- 页脚 -->
  {{ partial "footer.html" . }}
  <!-- JS 逻辑 -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // ================= 配置区域 =================
      const config = {
        apiBaseUrl: "https://la.581019.xyz/list", // 你的 API 服务器绝对 URL
        baseHeight: 220,
        targethdThumbSize: 400,
        targetudThumbSize: 1600,
        pageSize: 100, // 用于前端判断是否有下一页
        loadThresholdPx: 800 // 提前加载阈值 (用于 IntersectionObserver 和 API 加载)
      };

      // ================= 状态管理 =================
      let skiptoken = null;
      let isLoading = false;
      let hasMore = true;
      let imageObserver; // IntersectionObserver 实例

      // ================= DOM 引用 =================
      const galleryRoot = document.getElementById('gallery-root');
      const sentinel = document.getElementById('load-sentinel');
      const loadingText = document.getElementById('loading-text');
      const spinner = document.getElementById('loading-spinner');
      const viewer = document.getElementById('image-viewer');
      const fullImage = document.getElementById('full-image');
      const viewerLoading = document.getElementById('viewer-loading');
      const viewerClose = document.getElementById('viewer-close');
      const viewerFullscreen = document.getElementById('viewer-fullscreen');
      const monthGridCache = new Map();

      // ================= 辅助函数 =================

      /** 格式化日期，返回 YYYY/MM 标签 (兼容后端只返回 modified 字段) */
      function getDateLabel(file) {
        // 后端 transformOneDriveItem 返回 modified 和 thumb，使用 modified
        const isoDateString = file.modified || file.created;
        if (!isoDateString) return "未知日期";
        const date = new Date(isoDateString);
        return date.toISOString().substring(0, 7).replace('-', '/');
      }

      /** 获取或创建月份分组 DOM 节点 */
      function getMonthGrid(dateLabel) {
        if (monthGridCache.has(dateLabel)) return monthGridCache.get(dateLabel);
        const id = 'month-' + dateLabel.replace(/[\s\/]/g, '-');
        let section = document.getElementById(id);
        if (!section) {
          section = document.createElement('div');
          section.className = 'month-section';
          section.id = id;
          const headerText = dateLabel.split('/').join('年') + '月';
          section.innerHTML = `<div class="month-header">${headerText}</div><div class="photo-grid"></div>`;
          galleryRoot.appendChild(section);
        }
        const grid = section.querySelector('.photo-grid');
        monthGridCache.set(dateLabel, grid);
        return grid;
      }

      /** 处理单个图片文件，计算尺寸并渲染到网格中 */
      async function processAndRenderImage(file) {
        // 1. 缩略图 URL 替换
        let hdThumbUrl = file.thumb;
        let udThumbUrl = file.thumb;

        if (file.thumb && file.thumb.includes('width=') && file.thumb.includes('height=')) {
          hdThumbUrl = file.thumb.replace(/width=\d+/, `width=${config.targethdThumbSize}`)
            .replace(/height=\d+/, `height=${config.targethdThumbSize}`);
          udThumbUrl = file.thumb.replace(/width=\d+/, `width=${config.targetudThumbSize}`)
            .replace(/height=\d+/, `height=${config.targetudThumbSize}`);
        }

        // 2. 尺寸获取 (使用后端提供的 width/height)
        let dims = { width: file.width || 400, height: file.height || 300 };

        // 3. 计算瀑布流布局所需参数
        const dateLabel = getDateLabel(file);
        const grid = getMonthGrid(dateLabel);
        const flexWidth = dims.width * config.baseHeight / dims.height;
        const paddingBottom = (dims.height / dims.width) * 100;

        // 4. 构建并插入 DOM
        const itemDiv = document.createElement('div');
        itemDiv.className = 'photo-item';
        itemDiv.style.width = `${flexWidth}px`;
        itemDiv.style.flexGrow = flexWidth;

        // ★ 关键修改：使用 data-src 代替 src，实现手动预加载
        itemDiv.innerHTML = `
          <div class="photo-placeholder" style="padding-bottom: ${paddingBottom}%;"></div>
          <img data-src="${hdThumbUrl}"
            alt="${file.name}"
            onload="this.classList.add('loaded')"
            onerror="this.style.display='none'">
        `;
        itemDiv.onclick = () => openLightbox(udThumbUrl);
        grid.appendChild(itemDiv);

        // 返回图片元素用于观察者注册
        return itemDiv.querySelector('img');
      }

      // ================= Intersection Observer 逻辑 =================

      function initObserver() {
        if ('IntersectionObserver' in window) {
          imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const img = entry.target;
                const src = img.getAttribute('data-src');
                if (src) {
                  img.src = src; // 触发加载
                  img.removeAttribute('data-src');
                }
                observer.unobserve(img); // 停止观察已加载的图片
              }
            });
          }, {
            // rootMargin 必须是字符串，用于提前预加载
            rootMargin: `${config.loadThresholdPx}px 0px`
          });
        } else {
          // 兼容模式：不支持 IntersectionObserver 的浏览器，无法预加载
          imageObserver = null;
        }
      }

      // ================= 核心加载函数 (基于 skiptoken 值) =================
      async function loadNextPage() {
        if (isLoading || !hasMore) return;
        isLoading = true;
        loadingText.style.display = 'none';
        spinner.style.display = 'inline-block';

        let fetchUrl = config.apiBaseUrl;

        if (skiptoken) {
          // 后续请求：传递 skiptoken 值作为查询参数
          const params = new URLSearchParams();
          params.append('skiptoken', skiptoken);
          fetchUrl += '?' + params.toString();
        }

        try {
          const response = await fetch(fetchUrl);

          const contentType = response.headers.get("content-type");
          if (!response.ok || (contentType && contentType.indexOf("application/json") === -1)) {
            const errorText = await response.text();
            throw new Error(`API 请求失败，状态码: ${response.status}. 响应: ${errorText.substring(0, 100)}...`);
          }

          const result = await response.json();

          if (result.code === 200 && result.data.content) {
            const files = result.data.content;

            // ★ 核心：更新 skiptoken 状态
            skiptoken = result.data.skiptoken || null; // 读取后端返回的纯 skiptoken 值

            // 如果没有 skiptoken 且本页内容不足 pageSize，则认为加载完毕
            if (!skiptoken && files.length < config.pageSize) {
              hasMore = false;
            }

            const images = files.filter(file => !file.is_dir); // 假设只处理文件

            if (images.length > 0) {
              images.sort((a, b) => new Date(b.modified || b.created) - new Date(a.modified || a.created));

              // 收集新渲染的图片元素
              const newImages = await Promise.all(images.map(file => processAndRenderImage(file)));

              // 注册观察者
              if (imageObserver) {
                newImages.forEach(img => imageObserver.observe(img));
              } else {
                // Fallback: 如果不支持 IO，直接加载所有图片
                newImages.forEach(img => {
                  const src = img.getAttribute('data-src');
                  if (src) img.src = src;
                });
              }
            }

            // 如果本页没有图片，但还有 skiptoken，立即尝试加载下一页
            if (images.length === 0 && skiptoken) {
              setTimeout(() => { isLoading = false; loadNextPage(); }, 10);
              return;
            }
          } else {
            hasMore = false;
            console.error("API Error:", result.message || "未知错误");
            loadingText.innerText = "API 返回错误: " + (result.message || "请检查后端日志");
          }

        } catch (e) {
          console.error("Fetch Error:", e);
          loadingText.innerText = "网络请求失败: " + e.message;
          hasMore = false;
        } finally {
          isLoading = false;
          // 更新 sentinel 状态
          if (!hasMore) {
            spinner.style.display = 'none';
            loadingText.innerText = "—— 到底了 ——";
            loadingText.style.marginTop = "20px";
            loadingText.style.display = 'block';
            window.removeEventListener('scroll', handleScrollLoad);
          } else {
            spinner.style.display = 'inline-block';
            loadingText.style.display = 'block';
            loadingText.innerText = "正在加载...";
          }
        }
      }

      // ================= 提前加载监控 (Scroll Listener) =================
      function handleScrollLoad() {
        const totalHeight = document.documentElement.scrollHeight;
        const viewportHeight = window.innerHeight;
        const scrollPosition = window.scrollY || document.documentElement.scrollTop;
        const remainingDistance = totalHeight - (scrollPosition + viewportHeight);

        // 只有当 remainingDistance 小于阈值时，才触发 API 请求下一页数据
        if (remainingDistance < config.loadThresholdPx && hasMore && !isLoading) {
          loadNextPage();
        }
      }

      // ================= Lightbox 逻辑 =================
      function openLightbox(url) {
        viewer.classList.add('active');
        fullImage.style.display = 'none';
        viewerLoading.style.display = 'block';
        document.body.style.overflow = 'hidden';

        const tempImg = new Image();
        // 尝试设置高优先级 (如果浏览器支持 Fetch Priority)
        if ('fetchPriority' in tempImg) {
          tempImg.fetchPriority = 'high';
        }

        tempImg.src = url;
        tempImg.onload = () => {
          fullImage.src = url;
          viewerLoading.style.display = 'none';
          fullImage.style.display = 'block';
        };
        tempImg.onerror = () => {
          viewerLoading.style.display = 'none';
          alert('高清图片加载失败，请检查链接有效性。');
        };
      }

      function closeLightbox() {
        if (document.fullscreenElement) {
          document.exitFullscreen().catch(e => console.log("Exit fullscreen failed:", e));
        }
        viewer.classList.remove('active');
        fullImage.src = '';
        document.body.style.overflow = 'auto';
      }

      function toggleFullScreen() {
        if (!document.fullscreenElement) {
          viewer.requestFullscreen().catch(err => {
            console.error(`无法启用全屏: ${err.message}`);
          });
        } else {
          document.exitFullscreen();
        }
      }

      // ================= 初始化 =================
      initObserver(); // 初始化 Intersection Observer
      loadNextPage();
      window.addEventListener('scroll', handleScrollLoad);

      // Lightbox 事件绑定
      viewerClose.onclick = closeLightbox;
      if (viewerFullscreen) {
        viewerFullscreen.onclick = (e) => {
          e.stopPropagation();
          toggleFullScreen();
        };
      }
      viewer.onclick = (e) => {
        if (e.target === viewer || e.target === fullImage) closeLightbox();
      };
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && viewer.classList.contains('active')) {
          closeLightbox();
        }
      });
    });
  </script>
</body>

</html>