<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode | default " en" }}">

<head>
  <!-- 引入主题头部 (PaperMod 的 CSS 变量都在这里面) -->
  {{ partial "head.html" . }}
  <style>
    /* ================== 0. 核心变量适配 (修复暗黑模式) ================== */
    :root {
      --gallery-gap: 4px;
      --gallery-header-bg: rgba(255, 255, 255, 0.95);
      --gallery-border: rgba(0, 0, 0, 0.05);
    }

    body.dark {
      --gallery-header-bg: rgba(29, 30, 32, 0.95);
      --gallery-border: rgba(255, 255, 255, 0.1);
    }

    /* ================== 1. 基础布局 ================== */
    body {
      overflow-x: hidden;
      background-color: var(--theme) !important;
      color: var(--primary) !important;
      padding-bottom: 50px;
    }

    #gallery-root {
      margin: 0 auto;
      padding: 0;
      width: 100%;
      max-width: calc(var(--nav-width) + var(--gap) * 2);
    }

    /* ================== 2. 月份分组 ================== */
    .month-section {
      margin-bottom: 20px;
      animation: fadeIn 0.5s ease-in;
    }

    .month-header {
      font-size: 1.5rem;
      font-weight: 400;
      color: var(--primary);
      padding: 24px 8px 16px;
      position: sticky;
      top: 0;
      background-color: var(--gallery-header-bg);
      backdrop-filter: blur(10px);
      z-index: 90;
      border-bottom: 1px solid var(--gallery-border);
      transition: background-color 0.3s;
    }

    /* ================== 3. 图片网格 ================== */
    .photo-grid {
      display: flex;
      flex-wrap: wrap;
      margin: calc(var(--gallery-gap) * -1);
    }

    .photo-grid::after {
      content: '';
      flex-grow: 999999999;
    }

    .photo-item {
      margin: var(--gallery-gap);
      position: relative;
      background-color: var(--entry);
      overflow: hidden;
      cursor: zoom-in;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .photo-item:hover {
      transform: translateY(-2px);
      z-index: 2;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .photo-placeholder {
      height: 0;
      width: 100%;
    }

    .photo-item img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.4s ease-out;
    }

    .photo-item img.loaded {
      opacity: 1;
    }

    /* ================== 4. 加载与哨兵 ================== */
    #load-sentinel {
      text-align: center;
      padding: 40px;
      color: var(--secondary);
      font-size: 14px;
    }

    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(128, 128, 128, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 8px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ================== 5. Lightbox ================== */
    #image-viewer {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(5px);
      flex-direction: column;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #image-viewer.active {
      display: flex;
      opacity: 1;
    }

    /* 预览工具栏定位 */
    .viewer-toolbar {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1001;
      display: flex;
      gap: 20px;
    }

    #full-image {
      /* 默认 Lightbox 状态：保持比例，留黑边 */
      max-width: 95%;
      max-height: 95%;
      object-fit: contain;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    /* ★★★ 新增：当 #image-viewer 处于全屏模式时的样式 ★★★ */
    /* :fullscreen 伪类会自动匹配处于全屏模式的元素 */
    #image-viewer:-webkit-full-screen #full-image,
    #image-viewer:-moz-full-screen #full-image,
    #image-viewer:-ms-fullscreen #full-image,
    #image-viewer:fullscreen #full-image {
      /* 移除最大尺寸限制 */
      max-width: 100%;
      max-height: 100%;
      /* 核心修改：使用 cover 模式，铺满整个屏幕，超出部分裁剪 */
      object-fit: cover;
      /* 全屏状态下通常不需要阴影 */
      box-shadow: none;
    }


    /* 按钮通用样式 (针对包含 SVG 的 span) */
    #viewer-close,
    #viewer-fullscreen {
      cursor: pointer;
      user-select: none;
      transition: opacity 0.2s;
      /* 确保 SVG 容器是一个块级或行内块 */
      display: inline-block;
      /* 设置 SVG 颜色为白色 */
      color: #fff;
    }

    /* 确保 SVG 自身大小 */
    #viewer-close svg,
    #viewer-fullscreen svg {
      width: 32px;
      height: 32px;
      /* 让 SVG 继承父级 span 的颜色 */
      fill: currentColor;
    }

    #viewer-close:hover,
    #viewer-fullscreen:hover {
      opacity: 0.7;
    }

    #full-image {
      max-width: 95%;
      max-height: 95%;
      object-fit: contain;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    #viewer-loading {
      position: absolute;
      color: #fff;
    }

    @media (max-width: 600px) {
      .month-header {
        font-size: 1.4rem;
        padding: 15px 5px;
      }

      .photo-item {
        margin: 2px;
      }

      .photo-grid {
        margin: -2px;
      }

      .viewer-toolbar {
        top: 10px;
        right: 10px;
        gap: 15px;
      }
    }
  </style>
</head>

<body class="list" id="top">
  <!-- 导航栏 -->
  {{ partial "header.html" . }}
  <!-- 主内容区 -->
  <main style="width: 100%; max-width: 100%; padding: 0; min-height: 80vh;">
    <div id="gallery-root"></div>
    <div id="load-sentinel">
      <div class="spinner" id="loading-spinner"></div>
      <div id="loading-text">正在连接云端相册...</div>
    </div>
  </main>
  <!-- Lightbox (修改了结构并嵌入 SVG) -->
  <div id="image-viewer">
    <div class="viewer-toolbar">
      <span id="viewer-fullscreen" title="全屏模式">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="m15 3l2.3 2.3l-2.89 2.87l1.42 1.42L18.7 6.7L21 9V3zM3 9l2.3-2.3l2.87 2.89l1.42-1.42L6.7 5.3L9 3H3zm6 12l-2.3-2.3l2.89-2.87l-1.42-1.42L5.3 17.3L3 15v6zm12-6l-2.3 2.3l-2.87-2.89l-1.42 1.42l2.89 2.87L15 21h6z" />
        </svg>
      </span>
      <span id="viewer-close" title="关闭">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z" />
        </svg>
      </span>
    </div>
    <div id="viewer-loading" class="spinner" style="border-top-color: #fff;"></div>
    <img id="full-image">
  </div>
  <!-- 页脚 (PaperMod 的回到顶部按钮 top-link 在这里) -->
  {{ partial "footer.html" . }}
  <!-- JS 逻辑 (保持不变，因为 DOM ID 没有变) -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // ================= 配置区域 =================
      const config = {
        // ★ 注意：去掉末尾的斜杠 /，防止拼接成 //api/fs/list
        host: "https://la.581019.xyz/alist",
        path: "/Camera",
        baseHeight: 220,
        targethdThumbSize: 600,  // 列表视图分辨率
        targetudThumbSize: 1600, // 大图预览分辨率
        pageSize: 100,
        // 提前加载阈值
        loadThresholdPx: 800
      };
      let currentPage = 1;
      let isLoading = false;
      let hasMore = true;
      const galleryRoot = document.getElementById('gallery-root');
      const sentinel = document.getElementById('load-sentinel');
      const loadingText = document.getElementById('loading-text');
      const spinner = document.getElementById('loading-spinner');
      // 预览相关的 DOM
      const viewer = document.getElementById('image-viewer');
      const fullImage = document.getElementById('full-image');
      const viewerLoading = document.getElementById('viewer-loading');
      const viewerClose = document.getElementById('viewer-close');
      // ★ 新增：全屏按钮
      const viewerFullscreen = document.getElementById('viewer-fullscreen');
      const monthGridCache = new Map();

      function getDateLabel(isoDateString) {
        if (!isoDateString) return "未知日期";
        const date = new Date(isoDateString);
        return `${date.getFullYear()}/${date.getMonth() + 1}`;
      }
      function getMonthGrid(dateLabel) {
        if (monthGridCache.has(dateLabel)) return monthGridCache.get(dateLabel);
        const id = 'month-' + dateLabel.replace(/[\s年月]/g, '-');
        let section = document.getElementById(id);
        if (!section) {
          section = document.createElement('div');
          section.className = 'month-section';
          section.id = id;
          section.innerHTML = `<div class="month-header">${dateLabel}</div><div class="photo-grid"></div>`;
          galleryRoot.appendChild(section);
        }
        const grid = section.querySelector('.photo-grid');
        monthGridCache.set(dateLabel, grid);
        return grid;
      }

      // ★ 核心渲染函数 (恢复了阻塞式尺寸获取，并使用 file.created 字段)
      async function processAndRenderImage(file) {
        // 1. 初始化变量
        let hdThumbUrl = file.thumb;
        let udThumbUrl = file.thumb;
        // 2. 如果是微软链接，则进行高清替换
        if (file.thumb && file.thumb.includes('width=') && file.thumb.includes('height=')) {
          hdThumbUrl = file.thumb.replace(/width=\d+/, `width=${config.targethdThumbSize}`)
            .replace(/height=\d+/, `height=${config.targethdThumbSize}`);
          udThumbUrl = file.thumb.replace(/width=\d+/, `width=${config.targetudThumbSize}`)
            .replace(/height=\d+/, `height=${config.targetudThumbSize}`);
        }

        // 3. 尺寸获取 (阻塞等待，但准确)
        let dims = { width: 400, height: 300 };
        try {
          // 阻塞等待图片尺寸返回
          dims = await new Promise((resolve) => {
            const img = new Image();
            img.src = file.thumb;
            img.onload = () => resolve({ width: img.naturalWidth, height: img.naturalHeight });
            img.onerror = () => resolve({ width: 400, height: 300 });
          });
        } catch (e) { }

        // 4. 渲染 (使用 file.created 字段)
        const dateLabel = getDateLabel(file.created); // ★ 改变：使用 created 字段
        const grid = getMonthGrid(dateLabel);
        const flexWidth = dims.width * config.baseHeight / dims.height;
        const paddingBottom = (dims.height / dims.width) * 100;

        const itemDiv = document.createElement('div');
        itemDiv.className = 'photo-item';
        itemDiv.style.width = `${flexWidth}px`;
        itemDiv.style.flexGrow = flexWidth;
        itemDiv.innerHTML = `
          <div class="photo-placeholder" style="padding-bottom: ${paddingBottom}%;"></div>
          <img src="${hdThumbUrl}"
            loading="lazy"
            alt="${file.name}"
            onload="this.classList.add('loaded')"
            onerror="this.style.display='none'">
        `;
        itemDiv.onclick = () => openLightbox(udThumbUrl);
        grid.appendChild(itemDiv);
      }

      async function loadNextPage() {
        if (isLoading || !hasMore) return;
        isLoading = true;

        loadingText.style.display = 'none';
        spinner.style.display = 'inline-block';

        const requestData = {
          path: config.path,
          password: "",
          page: currentPage,
          per_page: config.pageSize,
          refresh: false
        };
        try {
          const response = await fetch(config.host + "/api/fs/list", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
          });
          // ★ 错误捕捉
          const contentType = response.headers.get("content-type");
          if (contentType && contentType.indexOf("application/json") === -1) {
            throw new Error("服务器返回了非 JSON 数据，可能是 Alist 页面 HTML。请检查 Worker 配置。");
          }
          const result = await response.json();
          if (result.code === 200 && result.data.content) {
            const files = result.data.content;
            if (files.length < config.pageSize) {
              hasMore = false;
            }
            const images = files.filter(file => file.type !== 1 && file.thumb);
            if (images.length > 0) {
              // ★ 关键排序：基于 file.created 字段进行时间倒序排序
              images.sort((a, b) => new Date(b.created) - new Date(a.created));

              // 批量等待图片尺寸获取和渲染完成
              await Promise.all(images.map(file => processAndRenderImage(file)));
              currentPage++;
            } else {
              if (hasMore) {
                currentPage++;
                setTimeout(() => { isLoading = false; loadNextPage(); }, 10);
                return;
              }
            }
          } else {
            hasMore = false;
          }
        } catch (e) {
          console.error(e);
          loadingText.innerText = "网络请求失败: " + e.message;
        } finally {
          isLoading = false;
          // 更新 sentinel 状态
          if (!hasMore) {
            spinner.style.display = 'none';
            loadingText.innerText = "—— 到底了 ——";
            loadingText.style.marginTop = "20px";
            loadingText.style.display = 'block';
            window.removeEventListener('scroll', handleScrollLoad); // 到底后移除监听
          } else {
            spinner.style.display = 'inline-block';
            loadingText.style.display = 'block';
            loadingText.innerText = "正在加载...";
          }
        }
      }

      // ================= 提前加载监控 (Scroll Listener) =================

      function handleScrollLoad() {
        const totalHeight = document.documentElement.scrollHeight;
        const viewportHeight = window.innerHeight;
        const scrollPosition = window.scrollY || document.documentElement.scrollTop;
        const remainingDistance = totalHeight - (scrollPosition + viewportHeight);

        // 如果剩余距离小于阈值，并且有更多内容，且当前没有加载任务
        if (remainingDistance < config.loadThresholdPx && hasMore && !isLoading) {
          loadNextPage();
        }
      }

      // 绑定滚动事件监听
      window.addEventListener('scroll', handleScrollLoad);

      // 首次加载（保证第一页内容出来）
      loadNextPage();

      // ================= Lightbox 逻辑 (包含全屏) =================
      function openLightbox(url) {
        viewer.classList.add('active');
        fullImage.style.display = 'none';
        viewerLoading.style.display = 'block';
        document.body.style.overflow = 'hidden';
        fullImage.src = url;
        fullImage.onload = () => {
          viewerLoading.style.display = 'none';
          fullImage.style.display = 'block';
        };
      }
      function closeLightbox() {
        if (document.fullscreenElement) {
          document.exitFullscreen().catch(e => console.log(e));
        }
        viewer.classList.remove('active');
        fullImage.src = '';
        document.body.style.overflow = 'auto';
      }
      function toggleFullScreen() {
        if (!document.fullscreenElement) {
          viewer.requestFullscreen().catch(err => {
            console.error(`无法启用全屏: ${err.message}`);
          });
        } else {
          document.exitFullscreen();
        }
      }
      // 绑定事件
      viewerClose.onclick = closeLightbox;
      if (viewerFullscreen) {
        viewerFullscreen.onclick = (e) => {
          e.stopPropagation();
          toggleFullScreen();
        };
      }
      viewer.onclick = (e) => {
        if (e.target === viewer || e.target === fullImage) closeLightbox();
      };
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && viewer.classList.contains('active')) {
          closeLightbox();
        }
      });
    });
  </script>
</body>

</html>